# credit_holidays

## Запуск
Перед запуском необходимо установить docker, docker-compose, и убедиться, что порты 8080 и 5431 не заняты.
1. Клонировать репозиторий `git clone git@gitlab.com:ses011/credit_holidays.git`.
2. Перейти в репозиторий `cd credit_holidays`.
3. Для запуска ввести команду `make up`.
4. Для остановки ввести команду `make down`.
5. Тесты запускаются командой `make test`.

## Описание

Документация, при запущенном приложении, доступна [тут](http://0.0.0.0:8080/swagger/index.html)
Пользователь (`user`) создается при первом изменении его баланса, имеет два типа баланса: обычный и зарезервированный.

Под услугой (`service`) понимается любое действие, изменяющее баланс пользователя. Услуга имеет две специфичные характеристики:
1. service_type - тип услуги (`accrual` - зачисление средств (увеличение баланса пользователя), `withdraw` - списание средств (уменьшение баланса)).
2. confirmation_needed - нужно ли услугу дополнительно подтверждать (например, услуга "зачисление средств на баланс пользователя" не требует подтверждение, средства начисляются сразу на активный баланс пользователя, услуга "вывод средств на внешний источник" требует подтверждения, поэтому изначально взаимодействует с зарезервированным балансом).

Любой запрос пользователя на услугу называется заказом (`order`).

Отчет (`report`) для бухгалтерии является csv файлом, сохраняемом на сервере. В ответ на запрос на создание отчета возвращается ссылка на него.

Используемая для рассчетов валюта - условная единица, равная 1/100 от принятой в регионе валюты (конкретно в моей реализации для рассчетов используется сотая часть рубля, то есть копейка). Это необходимо учитывать при работе с балансом пользователя и создаваемыми заказами.


## Примеры запросов
Запросы можно отправлять через swager, доступные [тут](http://0.0.0.0:8080/swagger/index.html), когда приложение запущено.

1. Пополнение баланса пользователя (`service_id = 1` -> пополнение баланса, если пользователя с таким user_id не существует, он создается автоматически (так написано в задании)):
   `curl -X 'POST' 'http://0.0.0.0:8080/order/add_order' -H 'accept: application/json' -H 'Content-Type: application/json' -d '{"amount": 10000, "service_id": 1, "user_id": 1}'`.
    Возвращает описание созданного заказа (заказ уже подтвержден, так как услуга "пополнение" не требует подтверждения)
2. Списание средств
   1. Создание заказа на списание средств (`service_id = 2` -> списание, 666 монет "резервируются" -> переносятся с основного баланса пользователя на frozen_balance): `curl -X 'POST' 'http://0.0.0.0:8080/order/add_order' -H 'accept: application/json' -H 'Content-Type: application/json' -d '{"amount": 666, "service_id": 2, "user_id": 1}'`. В ответ на запрос вернется `order_id`, например 2.
   2. Подтверждение заказа: `curl -X 'POST' 'http://0.0.0.0:8080/order/change_order_status' -H 'accept: application/json' -H 'Content-Type: application/json' -d '{"action": "proof", "order_id": 2}'`. Подтверждает заказ №2, то есть списывает средства с замороженного баланса пользователя.
   3. Отмена заказа: `curl -X 'POST' 'http://0.0.0.0:8080/order/change_order_status' -H 'accept: application/json' -H 'Content-Type: application/json' -d '{"action": "decline", "order_id": 2}'`. Отменяет заказ №2, средства возвращаются на основной баланс пользователя.
3. Запрос баланса пользователя: `curl -X 'GET' 'http://0.0.0.0:8080/user/get_balance?id=1' -H 'accept: application/json'`. Возвращает идентификатор пользователя, основной и замороженный баланс.
4. Запрос всех услуг: `curl -X 'GET' 'http://0.0.0.0:8080/service/get_all' -H 'accept: application/json'`. Возвращает список доступных услуг и их описанием.
5. Генерация отчета для бухгалтерии: `curl -X 'GET' 'http://0.0.0.0:8080/report/generate_report?month=10-2022' -H 'accept: application/json'`. Генерирует отчет, возвращает на него ссылку. Отчет доступен по ссылке.
